# *******************************************************************************
# Copyright (c) 2025 Contributors to the Eclipse Foundation
#
# See the NOTICE file(s) distributed with this work for additional
# information regarding copyright ownership.
#
# This program and the accompanying materials are made available under the
# terms of the Apache License Version 2.0 which is available at
# https://www.apache.org/licenses/LICENSE-2.0
#
# SPDX-License-Identifier: Apache-2.0
# *******************************************************************************

networks:
  docker-network:
    attachable: false
    driver: macvlan
    internal: true
    ipam:
      config:
        - subnet: 192.168.87.0/24
          gateway: 192.168.87.254

x-common: &common
  build:
    args:
      - http_proxy
      - https_proxy
      - no_proxy
    context: ../../..
    dockerfile: tests/integration/docker_setup/Dockerfile
  cap_add:
    - NET_ADMIN
  environment:
    GLOBAL_TIMEOUT: 240 minutes
  networks:
    - docker-network
  security_opt:
    - seccomp:unconfined
  ulimits:
    core: -1
  volumes:
    - ${SOURCE_DIR:-../../..}:/home/source
    - bazel-cache:/var/cache/bazel

volumes:
  bazel-cache:
    external: true
    name: eclipse-s-core-bazel-cache

services:
  someipd:
    !!merge <<: *common
    networks:
      docker-network:
        ipv4_address: 192.168.87.2
    depends_on:
      - client
    entrypoint: setarch -R tests/integration/docker_setup/entrypoint-master
    sysctls:
      net.ipv4.tcp_tw_reuse: 1 # Enable TIME_WAIT socket reuse
      net.ipv4.ip_local_port_range: 34600 60999 # Set local port range to exclude SOME/IP server port range

  client:
    !!merge <<: *common
    networks:
      docker-network:
        ipv4_address: 192.168.87.3
    entrypoint: setarch -R tests/integration/docker_setup/entrypoint-slave
    sysctls:
      net.ipv4.tcp_tw_reuse: 1 # Enable TIME_WAIT socket reuse
      net.ipv4.ip_local_port_range: 34600 60999 # Set local port range to exclude SOME/IP server port range
